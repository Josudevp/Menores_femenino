<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Torneo de Voleibol – 3 Grupos (6/6/7)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nav-link.active { background-color: #0284c7; color:#fff }
    .score-input { -moz-appearance:textfield; width:3.2rem; text-align:center }
    .score-input::-webkit-outer-spin-button, .score-input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0 }
    .invalid { outline: 2px solid #ef4444; background:#fee2e2 }
    .badge { border-radius:9999px; padding:.125rem .5rem; font-size:.75rem }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-20">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-xl md:text-2xl font-bold text-sky-700">Torneo de Voleibol</h1>
        <span class="badge bg-sky-100 text-sky-700">Formato: 3 grupos (6/6/7) + intergrupos A↔B</span>
      </div>
      <div class="hidden md:flex items-center gap-1">
        <a href="#grupos" class="nav-link px-3 py-2 rounded hover:bg-sky-100 active">Grupos</a>
        <a href="#resultados" class="nav-link px-3 py-2 rounded hover:bg-sky-100">Resultados</a>
        <a href="#calendario" class="nav-link px-3 py-2 rounded hover:bg-sky-100">Calendario</a>
        <a href="#ranking" class="nav-link px-3 py-2 rounded hover:bg-sky-100">Ranking</a>
        <a href="#fase-final" class="nav-link px-3 py-2 rounded hover:bg-sky-100">Fase Final</a>
        <a href="#config" class="nav-link px-3 py-2 rounded hover:bg-sky-100">Extras</a>
      </div>
      <div class="md:hidden">
        <select id="mobile-nav" class="border rounded px-2 py-1">
          <option value="#grupos">Grupos</option>
          <option value="#resultados">Resultados</option>
          <option value="#calendario">Calendario</option>
          <option value="#ranking">Ranking</option>
          <option value="#fase-final">Fase Final</option>
          <option value="#config">Extras</option>
        </select>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
    <!-- Summary -->
    <section class="mb-6">
      <div class="bg-sky-50 border border-sky-200 rounded p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-sky-800 mb-1">Objetivo de programación</h2>
          <p class="text-sm text-slate-600">19 equipos → 3 grupos: A(6), B(6), C(7). Cada equipo juega <strong>4 partidos</strong> en fase de grupos: A y B → 3 intra + 1 intergrupo A↔B; C(7) → 4 intra.</p>
        </div>
        <div class="text-sm">
          <div>Partidos de grupos estimados: <span id="stat-matches" class="font-bold">—</span></div>
          <div>Equipos: <span id="stat-teams" class="font-bold">19</span></div>
        </div>
      </div>
    </section>

    <!-- Grupos -->
    <section id="grupos" class="page hidden">
      <h2 class="text-2xl font-bold text-slate-900 mb-4">Composición de Grupos</h2>
      <p class="text-slate-600 mb-6">Puedes editar los nombres desde Configuración. El orden de tabla se actualiza con los resultados.</p>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="bg-white rounded shadow p-4">
          <h3 class="font-bold text-sky-700 mb-2">Grupo A (6)</h3>
          <ul id="list-A" class="list-disc list-inside text-sm"></ul>
          <table class="w-full text-sm mt-3">
            <thead class="bg-slate-100">
              <tr><th class="px-2 py-1 text-left">#</th><th class="px-2 py-1 text-left">Equipo</th><th class="px-2 py-1">PJ</th><th class="px-2 py-1">PG</th><th class="px-2 py-1">PP</th><th class="px-2 py-1">Pts</th></tr>
            </thead>
            <tbody id="table-A"></tbody>
          </table>
        </div>
        <div class="bg-white rounded shadow p-4">
          <h3 class="font-bold text-sky-700 mb-2">Grupo B (6)</h3>
          <ul id="list-B" class="list-disc list-inside text-sm"></ul>
          <table class="w-full text-sm mt-3">
            <thead class="bg-slate-100">
              <tr><th class="px-2 py-1 text-left">#</th><th class="px-2 py-1 text-left">Equipo</th><th class="px-2 py-1">PJ</th><th class="px-2 py-1">PG</th><th class="px-2 py-1">PP</th><th class="px-2 py-1">Pts</th></tr>
            </thead>
            <tbody id="table-B"></tbody>
          </table>
        </div>
        <div class="bg-white rounded shadow p-4">
          <h3 class="font-bold text-sky-700 mb-2">Grupo C (7)</h3>
          <ul id="list-C" class="list-disc list-inside text-sm"></ul>
          <table class="w-full text-sm mt-3">
            <thead class="bg-slate-100">
              <tr><th class="px-2 py-1 text-left">#</th><th class="px-2 py-1 text-left">Equipo</th><th class="px-2 py-1">PJ</th><th class="px-2 py-1">PG</th><th class="px-2 py-1">PP</th><th class="px-2 py-1">Pts</th></tr>
            </thead>
            <tbody id="table-C"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Resultados / Fixture -->
    <section id="resultados" class="page">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Programación y Resultados</h2>
        <div class="flex gap-2">
          <button id="btn-undo" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded">Deshacer</button>
          <button id="btn-export" class="px-3 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded">Exportar CSV</button>
        </div>
      </div>
      <p class="text-sm text-slate-600 mb-4">Sets: 25/25/15 con diferencia de 2. Los campos inválidos se resaltan en rojo.</p>

      <div class="grid gap-4" id="fixtures"></div>
    </section>

    <!-- Calendario -->
    <section id="calendario" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Calendario</h2>
        <div class="flex items-center gap-2">
          <label class="text-sm flex items-center gap-2"><input type="checkbox" id="notify-toggle" class="accent-sky-600"> Notificaciones de partidos (10 min antes)</label>
          <button id="btn-test-noti" class="px-3 py-2 bg-slate-200 rounded">Probar</button>
        </div>
      </div>
      <div id="calendar-list" class="space-y-3"></div>
    </section>

    <!-- Ranking General -->
    <section id="ranking" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">Ranking General</h2>
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="px-3 py-2 text-left">Pos</th>
              <th class="px-3 py-2 text-left">Equipo</th>
              <th class="px-3 py-2">Grupo</th>
              <th class="px-3 py-2">PJ</th>
              <th class="px-3 py-2">PG</th>
              <th class="px-3 py-2">PP</th>
              <th class="px-3 py-2">Pts</th>
              <th class="px-3 py-2">Win %</th>
            </tr>
          </thead>
          <tbody id="ranking-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Fase Final -->
    <section id="fase-final" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">Fase Final (8 mejores por Win%)</h2>
      <div class="bg-white rounded shadow p-4">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <h3 class="font-semibold text-center mb-2">Cuartos</h3>
            <div class="space-y-3">
              <div class="p-3 rounded border">
                <p class="text-xs mb-1 text-center">QF1 (1° vs 8°)</p>
                <div class="flex justify-between text-sm"><span id="qf1t1">—</span><span id="qf1t2">—</span></div>
              </div>
              <div class="p-3 rounded border">
                <p class="text-xs mb-1 text-center">QF2 (4° vs 5°)</p>
                <div class="flex justify-between text-sm"><span id="qf2t1">—</span><span id="qf2t2">—</span></div>
              </div>
              <div class="p-3 rounded border">
                <p class="text-xs mb-1 text-center">QF3 (2° vs 7°)</p>
                <div class="flex justify-between text-sm"><span id="qf3t1">—</span><span id="qf3t2">—</span></div>
              </div>
              <div class="p-3 rounded border">
                <p class="text-xs mb-1 text-center">QF4 (3° vs 6°)</p>
                <div class="flex justify-between text-sm"><span id="qf4t1">—</span><span id="qf4t2">—</span></div>
              </div>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-center mb-2">Semifinales</h3>
            <div class="space-y-3">
              <div class="p-3 rounded border"><p class="text-xs mb-1 text-center">SF1</p><div class="flex justify-between text-sm"><span id="sf1t1">Ganador QF1</span><span id="sf1t2">Ganador QF2</span></div></div>
              <div class="p-3 rounded border"><p class="text-xs mb-1 text-center">SF2</p><div class="flex justify-between text-sm"><span id="sf2t1">Ganador QF3</span><span id="sf2t2">Ganador QF4</span></div></div>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-center mb-2">Final</h3>
            <div class="p-3 rounded border"><p class="text-xs mb-1 text-center">FINAL</p><div class="flex justify-between text-sm"><span id="ft1">Ganador SF1</span><span id="ft2">Ganador SF2</span></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Config / Extras -->
    <section id="config" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">Configuración y Extras</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-white rounded shadow p-4">
          <h3 class="font-semibold mb-2">Equipos</h3>
          <p class="text-sm text-slate-600 mb-2">Edita nombres (1 por línea). Grupos: A(6), B(6), C(7).</p>
          <div class="grid md:grid-cols-3 gap-3">
            <textarea id="ta-A" class="border rounded p-2 h-48 text-sm" placeholder="Grupo A (6)"></textarea>
            <textarea id="ta-B" class="border rounded p-2 h-48 text-sm" placeholder="Grupo B (6)"></textarea>
            <textarea id="ta-C" class="border rounded p-2 h-48 text-sm" placeholder="Grupo C (7)"></textarea>
          </div>
          <div class="mt-3 flex gap-2">
            <button id="btn-aplicar-equipos" class="px-3 py-2 bg-sky-600 text-white rounded">Aplicar</button>
            <button id="btn-reset" class="px-3 py-2 bg-slate-200 rounded">Reset</button>
          </div>
        </div>
        <div class="bg-white rounded shadow p-4">
          <h3 class="font-semibold mb-2">Reglas de Validación</h3>
          <ul class="list-disc list-inside text-sm text-slate-700">
            <li>Set 1 y 2 a 25 puntos con <strong>diferencia ≥ 2</strong> (sin máximo).</li>
            <li>Set 3 (definición) a 15 con <strong>diferencia ≥ 2</strong>.</li>
            <li>Al guardar se valida y se marca en rojo lo inválido.</li>
          </ul>
          <h3 class="font-semibold mt-4 mb-2">Historial de cambios</h3>
          <p class="text-sm text-slate-600">Cada edición crea un punto de restauración. Usa <em>Deshacer</em> en Resultados.</p>
          <h3 class="font-semibold mt-4 mb-2">Sistema Suizo (idea)</h3>
          <p class="text-sm text-slate-600">Como alternativa, puedes usar 4 rondas con emparejamientos por rendimiento. Este demo prioriza el formato 3G (6/6/7) y deja el suizo como opción futura.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    // --------------------- Estado base ---------------------
    const defaultTeams = {
      A: ["Rojica","Thunders","Talentos VC","Top Volley","Volleytime Plus","Sendero A"],
      B: ["Sendero B","LVA A","DVA Yellow","WillyBall","Covoley","Cuervos"],
      C: ["DVA Blue","Southquilla","Snow Volley","Aston Quilla","Ballbreakers","Volleytime Ultra","LVA B"],
    };

    let teams = JSON.parse(localStorage.getItem('t3g_teams') || 'null') || structuredClone(defaultTeams);

    // Cada partido: {id, grupo:"A|B|C|AB" (AB=intergrupo), t1, t2, sets:[s1,s2,s3], dt: ISO, court}
    let fixtures = [];

    // Historial simple para deshacer (stack de estados serializados)
    const historyStack = [];
    const pushHistory = () => historyStack.push(JSON.stringify({fixtures, teams}));

    // --------------------- Utilidades ---------------------
    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));
    const fmtDateTime = iso => iso ? new Date(iso).toLocaleString() : '—';

    function save() {
      localStorage.setItem('t3g_teams', JSON.stringify(teams));
      localStorage.setItem('t3g_fixtures', JSON.stringify(fixtures));
    }
    function load() {
      const f = localStorage.getItem('t3g_fixtures');
      if (f) fixtures = JSON.parse(f);
    }

    // Round-robin (método círculo). Devuelve rondas (array de pares por ronda)
    function roundRobin(names) {
      const n = names.length;
      const arr = names.slice();
      if (n % 2 === 1) arr.push(null);
      const rounds = [];
      for (let r = 0; r < arr.length - 1; r++) {
        const pairs = [];
        for (let i = 0; i < arr.length/2; i++) {
          const a = arr[i];
          const b = arr[arr.length - 1 - i];
          if (a && b) pairs.push([a,b]);
        }
        rounds.push(pairs);
        // rotate
        const fixed = arr[0];
        const rest = arr.slice(1);
        rest.unshift(rest.pop());
        arr.splice(1, rest.length, ...rest);
      }
      return rounds;
    }

    // Emparejamientos 3G (6/6/7): A y B → 3 rondas intra; C → 4 rondas intra; más 1 intergrupo (A vs B) para cada equipo de A y B.
    function buildSchedule() {
      fixtures = [];
      // A intra 3 rondas
      const rA = roundRobin(teams.A).slice(0,3);
      // B intra 3 rondas
      const rB = roundRobin(teams.B).slice(0,3);
      // C intra 4 rondas
      const rC = roundRobin(teams.C).slice(0,4);

      let id = 1;
      const add = (grupo, t1, t2) => fixtures.push({ id: id++, grupo, t1, t2, sets:["","",""], dt:null, court:"" });

      rA.forEach(pairs => pairs.forEach(([a,b]) => add('A', a, b)));
      rB.forEach(pairs => pairs.forEach(([a,b]) => add('B', a, b)));
      rC.forEach(pairs => pairs.forEach(([a,b]) => add('C', a, b)));

      // Intergrupos A↔B: cada equipo de A juega 1 cruce con B y viceversa
      // Algoritmo simple: emparejar por índice (con rotación si sobran)
      const A = teams.A.slice();
      const B = teams.B.slice();
      for (let i=0;i<A.length;i++) {
        const a = A[i];
        const b = B[i % B.length];
        add('AB', a, b);
      }

      // Estadística
      el('#stat-matches').textContent = fixtures.length;
    }

    // --------------------- Render ---------------------
    function renderTeams() {
      ['A','B','C'].forEach(g => {
        const list = el('#list-'+g);
        list.innerHTML = teams[g].map(x=>`<li>${x}</li>`).join('');
      });
    }

    function renderTables() {
      const stats = computeStats();
      ['A','B','C'].forEach(g => {
        const body = el('#table-'+g);
        const rows = stats.byGroup[g].map((t,i)=>
          `<tr class="border-b">`+
          `<td class="px-2 py-1">${i+1}</td>`+
          `<td class="px-2 py-1">${t.name}</td>`+
          `<td class="px-2 py-1 text-center">${t.pj}</td>`+
          `<td class="px-2 py-1 text-center">${t.pg}</td>`+
          `<td class="px-2 py-1 text-center">${t.pp}</td>`+
          `<td class="px-2 py-1 text-center font-semibold">${t.pts}</td>`+
          `</tr>`).join('');
        body.innerHTML = rows;
      });
      renderRanking();
      renderBracket();
    }

    function scoreRowInput(fid, label, tSide) {
      const s = fixtures.find(f=>f.id===fid).sets;
      const [v1,v2,v3] = s;
      const pref = `data-fid="${fid}" data-side="${tSide}"`;
      return `
      <div class="flex items-center gap-1">
        <span class="text-xs text-slate-500 w-20 truncate">${label}</span>
        <input ${pref} data-set="1" type="number" class="score-input border rounded p-1" value="${v1?.[tSide-1]??''}" placeholder="S1">
        <input ${pref} data-set="2" type="number" class="score-input border rounded p-1" value="${v2?.[tSide-1]??''}" placeholder="S2">
        <input ${pref} data-set="3" type="number" class="score-input border rounded p-1" value="${v3?.[tSide-1]??''}" placeholder="S3">
      </div>`;
    }

    function renderFixtures() {
      const box = el('#fixtures');
      box.innerHTML = '';
      const groupsOrder = ['A','B','AB','C'];
      groupsOrder.forEach(gr => {
        const groupMatches = fixtures.filter(f=>f.grupo===gr);
        if (!groupMatches.length) return;
        const section = document.createElement('div');
        section.className = 'bg-white rounded shadow p-4';
        section.innerHTML = `<h3 class="font-semibold text-sky-700 mb-3">${gr==='AB'?'Intergrupos A↔B':'Grupo '+gr}</h3>`+
          `<div class="grid md:grid-cols-2 gap-3">${groupMatches.map(f=>
            `<div class="border rounded p-3" data-fid="${f.id}">
               <div class="flex items-center justify-between">
                 <div class="text-xs text-slate-500">ID ${f.id}</div>
                 <div class="flex items-center gap-2">
                   <input type="datetime-local" class="dt-input border rounded px-2 py-1 text-xs" value="${f.dt??''}" data-fid="${f.id}">
                   <input type="text" class="court-input border rounded px-2 py-1 text-xs w-28" placeholder="Cancha" value="${f.court}" data-fid="${f.id}">
                 </div>
               </div>
               <div class="mt-2 grid grid-cols-1 gap-2">
                 ${scoreRowInput(f.id, f.t1, 1)}
                 ${scoreRowInput(f.id, f.t2, 2)}
               </div>
             </div>`).join('')}</div>`;
        box.appendChild(section);
      });
      attachInputs();
      renderCalendar();
    }

    // --------------------- Validación ---------------------
    function isValidSet(a,b, setN) {
      if (a==='' || b==='') return true; // vacío permite seguir
      const A = parseInt(a), B = parseInt(b);
      if (Number.isNaN(A) || Number.isNaN(B)) return false;
      const target = setN===3 ? 15 : 25;
      const max = Math.max(A,B), min = Math.min(A,B);
      if (max < target) return false; // aún no llegó al objetivo
      return (max - min) >= 2;
    }

    function validateFixture(fid) {
      const card = document.querySelector(`[data-fid="${fid}"]`);
      const inputs = card.querySelectorAll('input.score-input');
      let ok = true;
      inputs.forEach(inp => {
        const setN = parseInt(inp.dataset.set);
        const side = parseInt(inp.dataset.side);
        const mate = card.querySelector(`input.score-input[data-set="${setN}"][data-side="${side===1?2:1}"]`);
        const valid = isValidSet(inp.value, mate.value, setN);
        inp.classList.toggle('invalid', !valid);
        if (!valid) ok = false;
      });
      return ok;
    }

    // --------------------- Cálculos ---------------------
    function computeStats() {
      const byName = {};
      const groupMap = {};
      ['A','B','C'].forEach(g=> teams[g].forEach(name=>{ byName[name] = {name, group:g, pj:0, pg:0, pp:0, pts:0, sf:0, sc:0}; groupMap[name]=g; }));
      fixtures.forEach(f=>{
        const s = f.sets;
        // contar sets ganados
        let t1=0, t2=0; let played=false;
        for (let i=0;i<3;i++) {
          const a = s[i]?.[0]; const b = s[i]?.[1];
          if (a!=='' && b!=='') { played=true; if (parseInt(a)>parseInt(b)) t1++; else if (parseInt(b)>parseInt(a)) t2++; }
        }
        if (played) {
          byName[f.t1].pj++; byName[f.t2].pj++;
          byName[f.t1].sf += t1; byName[f.t1].sc += t2;
          byName[f.t2].sf += t2; byName[f.t2].sc += t1;
          if (t1>t2) { byName[f.t1].pg++; byName[f.t2].pp++; byName[f.t1].pts+=2; byName[f.t2].pts+=1; }
          else if (t2>t1) { byName[f.t2].pg++; byName[f.t1].pp++; byName[f.t2].pts+=2; byName[f.t1].pts+=1; }
        }
      });
      const sorter = (a,b)=> b.pts-a.pts || b.pg-a.pg || (b.sf-b.sc)-(a.sf-a.sc) || a.name.localeCompare(b.name);
      const byGroup = {A:[],B:[],C:[]};
      Object.values(byName).forEach(t=> byGroup[t.group].push(t));
      ['A','B','C'].forEach(g=> byGroup[g].sort(sorter));
      const all = Object.values(byName).sort((a,b)=>{
        const wA = a.pj? a.pg/a.pj : 0; const wB = b.pj? b.pg/b.pj : 0;
        return wB - wA || sorter(a,b);
      });
      return { byGroup, all };
    }

    function renderRanking() {
      const {all} = computeStats();
      const tbody = el('#ranking-body');
      tbody.innerHTML = all.map((t,i)=>{
        const winp = t.pj? ((t.pg/t.pj)*100).toFixed(1)+'%' : '0.0%';
        return `<tr class="border-b">
          <td class="px-3 py-2">${i+1}</td>
          <td class="px-3 py-2">${t.name}</td>
          <td class="px-3 py-2 text-center">${t.group}</td>
          <td class="px-3 py-2 text-center">${t.pj}</td>
          <td class="px-3 py-2 text-center">${t.pg}</td>
          <td class="px-3 py-2 text-center">${t.pp}</td>
          <td class="px-3 py-2 text-center">${t.pts}</td>
          <td class="px-3 py-2 text-center font-semibold">${winp}</td>
        </tr>`;
      }).join('');
    }

    function renderBracket() {
      const {all} = computeStats();
      const top8 = all.slice(0,8).map(t=>t.name);
      const set = (id, val)=> el(id).textContent = val || '—';
      set('#qf1t1', top8[0]); set('#qf1t2', top8[7]);
      set('#qf2t1', top8[3]); set('#qf2t2', top8[4]);
      set('#qf3t1', top8[1]); set('#qf3t2', top8[6]);
      set('#qf4t1', top8[2]); set('#qf4t2', top8[5]);
    }

    // --------------------- Inputs & eventos ---------------------
    function attachInputs() {
      els('input.score-input').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const card = e.target.closest('[data-fid]');
          const fid = parseInt(card.dataset.fid);
          const setN = parseInt(e.target.dataset.set);
          const side = parseInt(e.target.dataset.side);
          const f = fixtures.find(x=>x.id===fid);
          if (!f.sets[setN-1]) f.sets[setN-1] = ["",""];
          f.sets[setN-1][side-1] = e.target.value;
          validateFixture(fid);
          pushHistory(); save();
          renderTables();
        });
      });
      els('.dt-input').forEach(inp=>{
        inp.addEventListener('change', e=>{
          const fid = parseInt(e.target.dataset.fid);
          fixtures.find(f=>f.id===fid).dt = e.target.value || null;
          pushHistory(); save();
          renderCalendar();
        });
      });
      els('.court-input').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const fid = parseInt(e.target.dataset.fid);
          fixtures.find(f=>f.id===fid).court = e.target.value;
          pushHistory(); save();
          renderCalendar();
        });
      });
    }

    // --------------------- Export CSV ---------------------
    function exportCSV() {
      const headers = ['ID','Grupo','Equipo 1','Equipo 2','S1','S2','S3','FechaHora','Cancha'];
      const rows = fixtures.map(f=>[
        f.id, f.grupo, f.t1, f.t2,
        (f.sets[0]||['','']).join('-'),
        (f.sets[1]||['','']).join('-'),
        (f.sets[2]||['','']).join('-'),
        f.dt||'', f.court||''
      ]);
      const csv = [headers].concat(rows).map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'torneo_volleyball_3G.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // --------------------- Calendario & Notificaciones ---------------------
    function renderCalendar() {
      const container = el('#calendar-list');
      const withDate = fixtures.filter(f=>f.dt).slice().sort((a,b)=> new Date(a.dt)-new Date(b.dt));
      if (!withDate.length) { container.innerHTML = '<p class="text-slate-600">Asigna fecha y hora en la pestaña Resultados.</p>'; return; }
      const byDay = {};
      withDate.forEach(f=>{
        const day = new Date(f.dt).toLocaleDateString();
        byDay[day] ||= []; byDay[day].push(f);
      });
      container.innerHTML = Object.keys(byDay).sort((a,b)=> new Date(a)-new Date(b)).map(day=>{
        const items = byDay[day].map(f=>`<li class="flex items-center justify-between border rounded p-2">
          <span class="text-sm">${new Date(f.dt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} · ${f.grupo==='AB'?'Intergrupos':('Grupo '+f.grupo)} · <strong>${f.t1}</strong> vs <strong>${f.t2}</strong> ${f.court?('· Cancha '+f.court):''}</span>
          <button class="px-2 py-1 text-xs bg-slate-200 rounded" data-jump="${f.id}">Ir</button>
        </li>`).join('');
        return `<div class="bg-white rounded shadow p-3">
          <h4 class="font-semibold mb-2">${day}</h4>
          <ul class="space-y-2">${items}</ul>
        </div>`;
      }).join('');
      els('[data-jump]').forEach(btn=> btn.addEventListener('click', e=>{
        const id = parseInt(e.currentTarget.dataset.jump);
        switchTab('#resultados');
        const card = document.querySelector(`[data-fid="${id}"]`);
        if (card) { card.scrollIntoView({behavior:'smooth', block:'center'}); card.classList.add('ring','ring-sky-300'); setTimeout(()=> card.classList.remove('ring','ring-sky-300'), 1500); }
      }));
      scheduleNotifications();
    }

    async function ensurePermission() {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission !== 'denied') {
        const p = await Notification.requestPermission();
        return p === 'granted';
      }
      return false;
    }

    function scheduleNotifications() {
      if (!el('#notify-toggle').checked) return;
      if (!('Notification' in window)) return;
      const now = Date.now();
      fixtures.forEach(f=>{
        if (!f.dt) return;
        const t = new Date(f.dt).getTime() - 10*60*1000; // 10 min antes
        if (t > now) {
          const delay = t - now;
          setTimeout(()=>{
            new Notification('Partido próximo', { body: `${f.t1} vs ${f.t2} en ${(new Date(f.dt)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${f.court?(' · Cancha '+f.court):''}` });
          }, Math.min(delay, 2147483647)); // limitar a ~24d
        }
      });
    }

    // --------------------- Navegación ---------------------
    function switchTab(hash) {
      els('.page').forEach(s=> s.classList.add('hidden'));
      document.querySelector(hash).classList.remove('hidden');
      els('.nav-link').forEach(a=> a.classList.remove('active'));
      const link = document.querySelector(`.nav-link[href="${hash}"]`); if (link) link.classList.add('active');
      el('#mobile-nav').value = hash;
    }

    // --------------------- Init + eventos globales ---------------------
    function seedTextareas() {
      el('#ta-A').value = teams.A.join('\n');
      el('#ta-B').value = teams.B.join('\n');
      el('#ta-C').value = teams.C.join('\n');
    }

    function applyTeamsFromTextareas() {
      const A = el('#ta-A').value.split('\n').map(s=>s.trim()).filter(Boolean);
      const B = el('#ta-B').value.split('\n').map(s=>s.trim()).filter(Boolean);
      const C = el('#ta-C').value.split('\n').map(s=>s.trim()).filter(Boolean);
      if (A.length!==6 || B.length!==6 || C.length!==7) {
        alert('Verifica cantidades: A(6), B(6), C(7).'); return;
      }
      teams = {A,B,C};
      pushHistory(); save();
      buildSchedule(); renderTeams(); renderFixtures(); renderTables(); renderCalendar();
    }

    function resetAll() {
      if (!confirm('Restablecer equipos y borrar resultados?')) return;
      teams = structuredClone(defaultTeams);
      fixtures = [];
      localStorage.removeItem('t3g_teams');
      localStorage.removeItem('t3g_fixtures');
      init();
    }

    function undo() {
      const prev = historyStack.pop();
      if (!prev) return;
      const st = JSON.parse(prev);
      teams = st.teams; fixtures = st.fixtures;
      save();
      seedTextareas(); renderTeams(); renderFixtures(); renderTables(); renderCalendar();
    }

    function init() {
      seedTextareas();
      buildSchedule();
      renderTeams();
      load(); // cargar posibles fixtures guardados
      renderFixtures();
      renderTables();
      renderCalendar();
      pushHistory();
    }

    // Eventos UI generales
    els('.nav-link').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); switchTab(a.getAttribute('href')); }));
    el('#mobile-nav').addEventListener('change', e=> switchTab(e.target.value));
    el('#btn-aplicar-equipos').addEventListener('click', applyTeamsFromTextareas);
    el('#btn-reset').addEventListener('click', resetAll);
    el('#btn-export').addEventListener('click', exportCSV);
    el('#btn-undo').addEventListener('click', undo);
    el('#notify-toggle').addEventListener('change', async ()=>{ if (await ensurePermission()) scheduleNotifications(); });
    el('#btn-test-noti').addEventListener('click', async ()=>{ if (await ensurePermission()) new Notification('Notificación de prueba', { body:'Así se verán los avisos de partido.' }); });

    // Observador: validar en tiempo real
    const obs = new MutationObserver(muts=>{
      muts.forEach(m=>{
        if (m.type==='attributes' && m.target.classList.contains('score-input')) {
          const card = m.target.closest('[data-fid]');
          validateFixture(parseInt(card.dataset.fid));
        }
      });
    });

    window.addEventListener('load', ()=>{
      init();
      els('input.score-input').forEach(i=> obs.observe(i, {attributes:true}));
    });
  </script>
</body>
</html>